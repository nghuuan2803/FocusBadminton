@page "/voucher-management"
@using AntDesign.TableModels
@using Shared.Members
@using Shared.Vouchers


<Flex Justify="FlexJustify.End" Gap="@("10")">
    <Button Type="ButtonType.Primary" Icon="@IconType.Outline.AppstoreAdd">Tạo mới</Button>
</Flex>
<Table @ref="_table" TItem="VoucherTemplateDTO" PageSize="10" Total="_total" DataSource="voucherTemplates" @bind-SelectedRows="_selectedRows">
    <PropertyColumn Property="c=>c.Id" Title="#">
        <a>@context.Id</a>
    </PropertyColumn>
    <PropertyColumn Property="c=>c.Name" Title="Tên mẫu">
        <a>@context.Name</a>
    </PropertyColumn>
    <PropertyColumn Property="c=>c.DiscountType" Title="Loại phiếu">
        <a>@(context.DiscountType == DiscountType.Percent ? "Phần trăm" : "Cố định")</a>
    </PropertyColumn>
    <PropertyColumn Property="c=>c.Value" Title="Trị giá">
        <a>@(context.DiscountType == DiscountType.Percent ? context.Value + " %" : context.Value.ToString("#,0 đ"))</a>
    </PropertyColumn>
    <ActionColumn Title="Tặng phiếu">
        <Space Size="SpaceSize.Middle">
            <SpaceItem>
                <Select DataSource="@members"
                        @bind-Value="@_selectedMember"
                        ItemLabel="p=>p.FullName"
                        Placeholder="Select a person"
                        EnableSearch
                        AutoClearSearchValue="false">
                </Select>
            </SpaceItem>
        </Space>
    </ActionColumn>
    <ActionColumn Title="Action">
        <Space Size="SpaceSize.Middle">
            <SpaceItem>
                <Button Icon="@IconType.Outline.Edit"></Button>
                <Button Icon="@IconType.Outline.Delete"></Button>
            </SpaceItem>
        </Space>
    </ActionColumn>
</Table>
<!-- Danh sách mẫu voucher -->
<!-- Modal tạo/sửa mẫu voucher -->
<Modal Title="@(editingTemplate == null ? "Tạo mẫu voucher" : "Sửa mẫu voucher")"
       Visible="@isTemplateModalVisible"
       OnOk="HandleTemplateSubmit"
       OnCancel="HideTemplateModal">
    <EditForm Model="@newTemplate" OnValidSubmit="HandleTemplateSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="form-group">
            <label>Tên mẫu</label>
            <InputText class="form-control" @bind-Value="@newTemplate.Name" />
        </div>
        <div class="form-group">
            <label>Mô tả</label>
            <InputTextArea class="form-control" @bind-Value="@newTemplate.Description" />
        </div>
        <div class="form-group">
            <label>Loại giảm giá</label>
            <InputSelect class="form-control" @bind-Value="@newTemplate.DiscountType">
                <option value="@DiscountType.Percent">Phần trăm</option>
                <option value="@DiscountType.Point">Số tiền cố định</option>
            </InputSelect>
        </div>
        <div class="form-group">
            <label>Giá trị</label>
            <AntDesign.InputNumber TValue="double" class="form-control" @bind-Value="@newTemplate.Value" Min="0" />
        </div>
        <div class="form-group">
            <label>Giá trị tối đa</label>
            <AntDesign.InputNumber TValue="double" class="form-control" @bind-Value="@newTemplate.MaximumValue" Min="0" />
        </div>
        <div class="form-group">
            <label>Thời hạn (ngày)</label>
            <AntDesign.InputNumber TValue="int" class="form-control" @bind-Value="@newTemplate.Duration" Min="1" />
        </div>
        <button type="submit" class="btn btn-primary mt-2" disabled="@isCreatingTemplate">
            @(isCreatingTemplate ? "Đang xử lý..." : (editingTemplate == null ? "Tạo mẫu" : "Cập nhật"))
        </button>
    </EditForm>
</Modal>

<!-- Modal tặng voucher -->
<Modal Title="Tặng voucher"
       Visible="@isGiftModalVisible"
       OnOk="HandleGiftVoucher"
       OnCancel="HideGiftVoucherModal">
    <div class="form-group">
        <label>Chọn mẫu voucher</label>
        <InputSelect class="form-control" @bind-Value="@voucherRequest.VoucherTemplateId">
            <option value="0">Chọn mẫu...</option>
            @foreach (var template in voucherTemplates)
            {
                <option value="@template.Id">@template.Name</option>
            }
        </InputSelect>
    </div>
    <div class="form-group">
        <label>Ngày hết hạn (tùy chọn)</label>
        <InputDate class="form-control" @bind-Value="@voucherRequest.Expiry" />
    </div>
</Modal>

@code {
    string _selectedValue;
    MemberDTO _selectedMember;
    ITable _table;
    private List<VoucherTemplateDTO> voucherTemplates = new();
    private List<MemberDTO> members = new();
    private VoucherRequest voucherRequest = new VoucherRequest();
    private bool isCreatingTemplate = false;
    private bool isCreatingVoucher = false;
    private HashSet<string> selectedMemberIds = new();

    private bool isTemplateModalVisible = false;
    private bool isGiftModalVisible = false;
    private string templateSearch = string.Empty;
    private int templatePageSize = 10;
    private int templatePageNumber = 1;
    private int templateTotal = 0;
    private string memberSearch = string.Empty;
    private int memberPageSize = 10;
    private int memberPageNumber = 1;
    private int memberTotal = 0;
    int _total;

    void OnSelectedItemChangedHandler(MemberDTO member)
    {
        _selectedMember = member;
    }
}
